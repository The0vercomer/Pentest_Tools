#!/bin/bash

#This script performs various defense detections on Linux/Unix systems.
#The commands for detection within this script are courtesy of Carlos Polop Marton#!/bin/bash

#This script performs various defense detections on Linux/Unix systems.
#The commands for detection within this script are courtesy of Carlos Polop Martin,
#with some minor tweaks, and were obtained via https://book.hacktricks.xyz/.

GREEN='\033[0;32m'
RED='\033[0;31m'
WHITE='\033[1;37m'
RESET='\033[0m'

echo "${WHITE}${BOLD}\n\nPerforming AppArmor detection.\n${RESET}${NORMAL}"

if [ `which aa-status 2>/dev/null` ]; then
    echo "${RED}AppArmor Detected${RESET}" && aa-status
  elif [ `which apparmor_status 2>/dev/null` ]; then
    echo "${RED}AppArmor Detected${RESET}" && apparmor_status
  elif [ `ls -d /etc/apparmor* 2>/dev/null` ]; then
    echo "${RED}AppArmor Detected${RESET}" && ls -d /etc/apparmor*
  else
    echo "${GREEN}Not found AppArmor${RESET}"
fi

echo "${WHITE}\nPerforming Grsecurity detection.\n${RESET}"

((uname -r | grep "\-grsec" >/dev/null 2>&1 || grep "grsecurity" /etc/sysctl.conf >/dev/null 2>&1) && echo "${RED}Yes${RESET}" || echo "${GREEN}Not found grsecurity${RESET}")

echo "${WHITE}\nPerforming PaX detection.\n${RESET}"

(which paxctl-ng paxctl >/dev/null 2>&1 && echo "${RED}PaX Detected${RESET}" || echo "${GREEN}Not found PaX${RESET}")

echo "${WHITE}\nPerforming Execshield detection.\n${RESET}"

if [ `grep "exec-shield" /etc/sysctl.conf 2>/dev/null` ]; then
    echo "${RED}Execshield Detected${RESET}" && grep "exec-shield" /etc/sysctl.conf
  else
    echo "${GREEN}Not found Execshield\n${RESET}"
fi

echo "${WHITE}Performing SElinux detection.\n${RESET}"

if [ `which sestatus 2>/dev/null` ]; then
    echo "${RED}SElinux Detected${RESET}" && sestatus 2>/dev/null
  else
    echo "${GREEN}Not found sestatus\n${RESET}"
fi

echo "${WHITE}\nPerforming ASLR detection.\n${RESET}"

echo -n "ASLR status: " && cat /proc/sys/kernel/randomize_va_space 2>/dev/null

echo """\n${GREEN}0${RESET} – No randomization. Everything is static.
${RED}1${RESET} – Conservative randomization. Shared libraries, stack, mmap(), VDSO and heap are randomized.
${RED}2${RESET} – Full randomization. In addition to elements listed in the previous point, memory managed through brk() is also randomized.\n"""
,
#and were obtained via https://book.hacktricks.xyz/.

GREEN='\033[0;32m'
RED='\033[0;31m'
WHITE='\033[1;37m'
RESET='\033[0m'

echo "${WHITE}${BOLD}\n\nPerforming AppArmor detection.\n${RESET}${NORMAL}"

if [ `which aa-status 2>/dev/null` ]; then
    echo "${RED}AppArmor Detected${RESET}" && aa-status
  elif [ `which apparmor_status 2>/dev/null` ]; then
    echo "${RED}AppArmor Detected${RESET}" && apparmor_status
  elif [ `ls -d /etc/apparmor* 2>/dev/null` ]; then
    echo "${RED}AppArmor Detected${RESET}" && ls -d /etc/apparmor*
  else
    echo "${GREEN}Not found AppArmor${RESET}"
fi

echo "${WHITE}\nPerforming Grsecurity detection.\n${RESET}"

((uname -r | grep "\-grsec" >/dev/null 2>&1 || grep "grsecurity" /etc/sysctl.conf >/dev/null 2>&1) && echo "${RED}Yes${RESET}" || echo "${GREEN}Not found grsecurity${RESET}")

echo "${WHITE}\nPerforming PaX detection.\n${RESET}"

(which paxctl-ng paxctl >/dev/null 2>&1 && echo "${RED}PaX Detected${RESET}" || echo "${GREEN}Not found PaX${RESET}")

echo "${WHITE}\nPerforming Execshield detection.\n${RESET}"

if [ `grep "exec-shield" /etc/sysctl.conf 2>/dev/null` ]; then
    echo "${RED}Execshield Detected${RESET}" && grep "exec-shield" /etc/sysctl.conf
  else
    echo "${GREEN}Not found Execshield\n${RESET}"
fi

echo "${WHITE}Performing SElinux detection.\n${RESET}"

if [ `which sestatus 2>/dev/null` ]; then
    echo "${RED}SElinux Detected${RESET}" && sestatus 2>/dev/null
  else
    echo "${GREEN}Not found sestatus\n${RESET}"
fi

echo "${WHITE}\nPerforming ASLR detection.\n${RESET}"

echo -n "ASLR status: " && cat /proc/sys/kernel/randomize_va_space 2>/dev/null

echo """\n${GREEN}0${RESET} – No randomization. Everything is static.
${RED}1${RESET} – Conservative randomization. Shared libraries, stack, mmap(), VDSO and heap are randomized.
${RED}2${RESET} – Full randomization. In addition to elements listed in the previous point, memory managed through brk() is also randomized.\n"""
